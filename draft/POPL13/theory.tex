\section{Metatheory}
\label{sec:theory}

Before go on to prove subjected reduction and strong normalization, we need to
check some basic well-formedness properties for the derivations of \Fi.
We want to show that the sorting, kinding, and typing derivations give
well-formed results under well-formed contexts. That is, sorting derivations
result in well-formed sorts (Proposition \ref{prop:wfsort}),
kinding derivations result in well-sorted kinds under well-formed
type level contexts (Proposition \ref{prop:wfkind}), and typing derivations
result in well-kinded types under well-formed type and term level contexts
(Proposition \ref{prop:wftype}).

Since the definitions of sorting, kinding, and typing rules are
mutually recursive, these three properties should really be considered as
one big property (illustrated below) in order to be more rigorous about
the induction principle used in the proof.
\begin{proposition*}[The big well-formedness propoerty of \Fi,
		roughly\footnote{Technically,
    this is not yet completely rigorous since there are three more forms of
    judgments in the mutually recursive definition. The \emph{kind equality},
    \emph{type considered equality}, and \emph{term equality} rules are part of
    the mutually recursive definition along with the sorting, kinding, and
    typing rules. So, the complete description of the big well-formedness
    property will consist of six cases, which correspond to
    Proposition \ref{prop:wfsort}, Proposition \ref{prop:wfkind},
    Proposition \ref{prop:wftype}, Lemma \ref{lem:wfeqkind},
    Lemma \ref{lem:wfeqtype}, and Lemma \ref{lem:wfeqterm}.  }  ]~
\begin{quote}
\begin{itemize}
\item[case] \fbox{$ |- \kappa : \square $}\qquad\quad
 $ \inference{ |- \kappa : \mathfrak{s} }{ \mathfrak{s}=\square } $\\
 \qquad\qquad (Proposition \ref{prop:wfsort})
\item[case] \fbox{$ \Delta |- F : \kappa $}\qquad
 $ \inference{ |- \Delta & \Delta |- F : \kappa}{ |- \kappa:\square } $\\
 \qquad\qquad (Proposition \ref{prop:wfkind})
\item[case] \fbox{$ \Delta;\Gamma |- t:A $}\quad
 $ \inference{ \Delta |- \Gamma & \Delta;\Gamma |- t : A}{ \Delta |- A : * } $\\
 (Proposition \ref{prop:wftype})
\end{itemize}
\end{quote}
\end{proposition*}\noindent
The big well-formedness property about derivations for a judgment,
which can be either one of the three forms --
\fbox{$ |- \kappa : \square $} (sorting),
\fbox{$ \Delta |- F : \kappa $} (kinding), and
\fbox{$ \Delta;\Gamma |- t:A $} typing.
That is, a derivation for a judgment of either sorting, kinding, or typing
results in either a well-formed sort (when it is a sorting judgment),
a well-sorted kind (when it is a kinding judgment), or
a well-kinded type (when it is a typing judgment),
under well-formed contexts for the judgment (no context for sorting judgments,
$\Delta$ for kinding judgments, and $\Delta;\Gamma$ for typing judgments).

We can prove the big well-formedness property of \Fi\ by induction on
the derivation of a judgment, which can be either one of the three forms.
Here, I illustrate the proof for the three propositions as if they were
separate proofs. During the proof description, the proof for each proposition
references the other properties (which is yet another application of the
induction hypothesis of the big well-formedness property), since it gives
more intuitive proof sketch that way. So, when I say ``by induction''
during the proofs, what I really mean is the induction hypothesis of
the big well-formedness property.

\begin{proposition}[sorting derivations result in well-formed sorts]
\label{prop:wfsort}
\[ \inference{ |- \kappa : \mathfrak{s} }{ \mathfrak{s}=\square } \]
\end{proposition}
\begin{proof}Obvious since $\square$ is the only sort in \Fi.\end{proof}

\begin{proposition}[kinding derivations under well-formed contexts
	       	result in well-sorted kinds]
\label{prop:wfkind}
\[ \inference{ |- \Delta & \Delta |- F : \kappa}{ |- \kappa:\square }
\]
\end{proposition}
\begin{proof} By induction on the derivation.
\begin{itemize}
\item[case] ($Var$)
	Trivial by the second well-formedness rule of $\Delta$.
\item[case] ($Conv$) \\
	By induction and Lemma \ref{lem:wfeqkind}.
\item[case] ($\lambda$) \\
	By induction and Proposition \ref{prop:wfsort} we know
	that $|- \kappa:\square$.\\
	By the second well-formedness rule of $\Delta$,
	we know that $|- \Delta,X^\kappa$ since we already know
	that $|- \kappa:\square$ and $|- \Delta$ from the property statement.\\
	By induction, we know that $|- \kappa':\square$
	since we already know that $|- \Delta,X^\kappa$ and
	that $\Delta,X^\kappa|- F:\kappa'$ from induction hypothesis.\\
	By the sorting rule ($R$), we know that $|- \kappa -> \kappa':\square$
	since we already know that $|- \kappa:\square$ and $|- \kappa':\square$.
\item[case] ($@$)
	By induction, easy.
\item[case] ($\lambda i$)\\
	By induction and Proposition \ref{prop:wftype} we know
	that $\cdot|- A:*$.
	By the third well-formedness rule of $\Delta$,
	we know that $|- \Delta,i^A$ since we already know that $\cdot|- A:*$ and
	that $|- \Delta$ from the property statement.\\
	By induction, we know that $|- \kappa:\square$
	since we already know that $|- \Delta,i^A$ and
	that $\Delta,i^A|- F:\kappa$ from the induction hypothesis.\\
	By the sorting rule ($Ri$), we know that $|- A -> \kappa:\square$
	since we already know that $\cdot |- A:*$ and $|- \kappa:\square$.
\item[case] ($@i$)
	By induction and Proposition \ref{prop:wftype}, easy.
\item[case] ($->$)
	Trivial since $|- * : \square$.
\item[case] ($\forall$)
	Trivial since $|- * : \square$.
\item[case] ($\forall i$)
	Trivial since $|- * : \square$.
\end{itemize}
\end{proof}

The basic structure of the proof for the following proposition on typing
derivations is similar to above. So, I illustrate the proof for most of
the cases, which can be done by applying the induction hypothesis, rather
bravely. I elaborate more on interesting cases ($\forall E$) and ($\forall Ei$)
which involve substitutions in the types resulting from the typing judgments.
\begin{proposition}[typing derivations under well-formed contexts result in
	well-kinded types]
\label{prop:wftype}
\[ \inference{ \Delta |- \Gamma & \Delta;\Gamma |- t : A}{ \Delta |- A : * }
\]
\end{proposition}
\begin{proof} By induction on the derivation.
\begin{itemize}
\item[case] ($:$)
	Trivial by the second well-formedness rule of $\Gamma$.
\item[case] ($:i$)
	Trivial by the third the well-formedness rule of $\Delta$.
\item[case] ($=$)
	By induction and Lemma \ref{lem:wfeqtype}.
\item[case] ($->$$I$)
	By induction and well-formedness of $\Gamma$.
\item[case] ($->$$E$)
	By induction.
\item[case] ($\forall I$)
	By induction and well-formedness of $\Delta$.
\item[case] ($\forall E$)\\
	By induction we know that $\Delta |- \forall X^\kappa.B : *$.\\
	By the kinding rule ($\forall$), which is the only kinding rule
	able to derive $\Delta |- \forall X^\kappa.B : *$, we know
	that $\Delta,X^\kappa |- B : *$.\\
	Then, we use the type substitution lemma (Lemma \ref{lem:tysubst}).
\item[case] ($\forall Ii$)
	By induction and well-formedness of $\Delta$.
\item[case] ($\forall Ei$)\\
	By induction we know that $\Delta |- \forall i^A.B : *$.\\
	By the kinding rule ($\forall i$), which is the only kinding rule
	able to derive $\Delta |- \forall i^A.B : *$, we know
	that $\Delta,i^A |- B : *$.\\
	Then, we use the index substitution lemma (Lemma \ref{lem:ixsubst}).
\end{itemize}
\end{proof}

\begin{lemma}[kind equality is well-sorted]\label{lem:wfeqkind}
$ \inference{|- \kappa = \kappa':\square}
	{|- \kappa:\square \quad |- \kappa':\square} $
\end{lemma}
\begin{proof}
	By induction on the derivation of kind equality
	and using the sorting rules.
\end{proof}

\begin{lemma}[type constructor equality is well-kinded]\label{lem:wfeqtype}
\[ \inference{\Delta |- F = F':\kappa}
	{\Delta |- F:\kappa \quad \Delta |- F':\kappa}
\]
\end{lemma}
\begin{proof}
	By induction on the derivation of type constructor equality
	and using the kinding rules.

	Also use the type substitution lemma (Lemma \ref{lem:tysubst})
	and the index substitution lemma (Lemma \ref{lem:ixsubst}).
\end{proof}

\begin{lemma}[term equality is well-typed]\label{lem:wfeqterm}
\[ \inference{\Delta,\Gamma |- t = t':A}
	{\Delta,\Gamma |- t:A \quad \Delta,\Gamma |- t':A}
\]
\end{lemma}
\begin{proof}
	By induction on the derivation of term equality
	and using the typing rules.

	Also use the term substitution lemma (Lemma \ref{lem:tmsubst}).
\end{proof}

The proofs for the three lemmas above are straightforward
once we have dealt with the interesting cases for the equality rules
involving substitution. We can prove those interesting cases
by applying the substitution lemmas. The other cases fall into two
categories: firstly, the equality rules following the same structure of
the sorting, kinding, and typing rules; and secondly, the reflexive
rules and the transitive rules. The proof for the equality rules
following the same structure of the sorting, kinding, and typing rules
can be proved by induction and applying the correspoinding
sorting, kinding, and typing rules. The proof for the reflexive rules
and the transitive rules can be proved simply by induction.

\begin{lemma}[type substitution]\label{lem:tysubst}
$ \inference{\Delta,X^\kappa |- F:\kappa' & \Delta |- G:\kappa}
	{\Delta |- [G/X]F:\kappa'} $
\end{lemma}

\begin{lemma}[index substitution]\label{lem:ixsubst}
$ \inference{\Delta,i^A |- F:\kappa & \Delta;\cdot |- s:A}
	{\Delta |- [s/i]F:\kappa} $
\end{lemma}

\begin{lemma}[term substitution]\label{lem:tmsubst}
$ \inference{\Delta;\Gamma,x:A |- t:B & \Delta;\cdot |- s:A}
	{\Delta,\Gamma |- [s/x]t:B} $
\end{lemma}



\begin{proposition}[anti-dependency on arrow kinds]
\[ \inference{ |- \Delta,X^\kappa
             & \Delta,X^\kappa |- F : \kappa' }
             { X\notin\FV(\kappa') }
\]
\end{proposition}
\begin{proof}
	By Proposition \ref{prop:wfkind}, $|- \kappa'$.
	Note that $|- \kappa'$ does not involve any type level context.

	Therefore, $X$ cannot appear free in $\kappa'$.
\end{proof}

\begin{proposition}[anti-dependency on indexed arrow kinds]
\[ \inference{ |- \Delta,i^A
             & \Delta,i^A |- F : \kappa }
             { i\notin\FV(\kappa) }
\]
\end{proposition}
\begin{proof}
	By Proposition \ref{prop:wfkind}, $|- \kappa'$.
	Note that $|- \kappa'$ does not involve any type level context.

	Therefore, $i$ cannot appear free in $\kappa'$.
\end{proof}

\begin{proposition}[anti-dependency on arrow types]
\[ \inference{ \Delta |- \Gamma,x:A
             & \Delta;\Gamma,x:A |- t : B }
             { x\notin\FV(B) }
\]
\end{proposition}
\begin{proof}
	By Proposition \ref{prop:wftype}, $\Delta |- B$.
	Note that $\Delta |- \kappa'$ does not involve any term level context.

	Therefore, $x$ cannot appear free in $B$.
\end{proof}


\begin{remark} Our system is more strong??? than anti-dependency on arrow types
TODO
\end{remark}

\paragraph{}
\begin{definition}[index erasure]\label{def:ierase}
\[ \fbox{$\kappa^\circ$}
 ~~~~ ~~
 *^\circ =
 *
 ~~~~ ~~
 (\kappa -> \kappa')^\circ =
 \kappa^\circ -> \kappa^\circ
 ~~~~ ~~
 (A -> \kappa)^\circ =
 \kappa
\]
\[ \fbox{$F^\circ$}
 ~~~~
 X^\circ =
 X
 ~~~~ ~~~~
 (A -> B)^\circ =
 A^\circ -> B^\circ
\]
\[ \qquad
 (\lambda X^\kappa.F)^\circ =
 \lambda X^{\kappa^\circ}.F^\circ
 ~~~~ ~~~~
 (\lambda i^A.F)^\circ =
 F^\circ
\]
\[ \qquad
 (F\;G)^\circ =
 F^\circ\;G^\circ
 ~~~~ ~~~~ ~~~~ ~~~~ ~~
 (F\,\{s\})^\circ =
 F^\circ
\]
\[ \qquad
 (\forall X^\kappa . B)^\circ =
 \forall X^{\kappa^\circ} . B^\circ
 ~~~~ ~~~~
 (\forall i^A . B)^\circ =
 B^\circ
\]
\[ \fbox{$\Delta^\circ$}
 ~~~~
 \cdot^\circ = \cdot
 ~~~~ ~~
 (\Delta,X^\kappa)^\circ = \Delta^\circ,X^{\kappa^\circ}
 ~~~~ ~~
 (\Delta,i^A)^\circ = \Delta^\circ
\]
\[ \fbox{$\Gamma^\circ$}
 ~~~~
 \cdot^\circ = \cdot
 ~~~~ ~~~~
 (\Gamma,x:A)^\circ = \Gamma^\circ,x:A^\circ
\]
\end{definition}

\begin{theorem}[index erasure on well-sorted kinds]
\label{thm:ierasesorting}
	$\inference{|- \kappa : \square}{|- \kappa^\circ : \square}$
\end{theorem}
\begin{proof}
	By induction on the sorting derivation.
\end{proof}
\begin{remark}
For any well-sorted kind $\kappa$ in \Fi,
$\kappa^\circ$ is a kind in \Fw.
\end{remark}

\begin{theorem}[index erasure on well-formed type level contexts]
\label{thm:ierasetyctx}
\[ \inference{|- \Delta}{|- \Delta^\circ} \]
\end{theorem}
\begin{proof}
	By induction on the derivation for well-formed type level context
	and using Theorem \ref{thm:ierasesorting}.
\end{proof}
\begin{remark}
For any well-formed type level context $\Delta$ in \Fi,
$\Delta^\circ$ is a well-formed type level context in \Fw.
\end{remark}

\begin{theorem}[index erasure on kind equality]\label{thm:ierasekindeq}
$ \inference{|- \kappa=\kappa':\square}
	{|- \kappa^\circ=\kappa'^\circ:\square}
$
\end{theorem}
\begin{proof}
	By induction on the kind equality judgement.
\end{proof}
\begin{remark}
For any well-sorted kind equality $|- \kappa=\kappa':\square$ in \Fi,
$|- \kappa^\circ=\kappa'^\circ:\square$ is a well-sorted kind equality in \Fw.
\end{remark}

The three theorems above on kinds are rather simple to prove since there is
no need to consider mutual recursion in the definition of kinds due to
the erasure operation on kinds. Recall that the erasure operation on kinds
discards the type ($A$) appearing in the index arrow type ($A -> \kappa$).
So, there is no need to consider the types appearing in kinds
and the index terms appearing in those types, after the erasure.\\

\begin{theorem}[index erasure on well-kinded type constructors]
\label{thm:ierasekinding}
\[ \inference{|- \Delta & \Delta |- F : \kappa}
		{\Delta^\circ |- F^\circ : \kappa^\circ}
\]
\end{theorem}
\begin{proof}
	By induction on the kinding derivation.
\begin{itemize}
\item[case] ($Var$)
	Use Theorem \ref{thm:ierasetyctx}.

\item[case] ($Conv$)
	By induction and using Theorem \ref{thm:ierasekindeq}.

\item[case] ($\lambda$)
	By induction and using Theorem \ref{thm:ierasesorting}.

\item[case] ($@$)
	By induction.

\item[case] ($\lambda i$)

	We need to show that
	$\Delta^\circ |- (\lambda i^A.F)^\circ : (A -> \kappa)^\circ$,
	which simplifies to $\Delta^\circ |- F^\circ : \kappa^\circ$
	by Definition \ref{def:ierase}.

	By induction, we know that
	$(\Delta,i^A)^\circ |- F^\circ : \kappa^\circ $,
	which simplifies $\Delta^\circ |- F^\circ : \kappa^\circ$
	by Definition \ref{def:ierase}.

\item[case] ($@ i$)

	We need to show that
	$\Delta^\circ |- (F\;\{s\})^\circ : \kappa^\circ$,
	which simplifies to $\Delta^\circ |- F^\circ : \kappa^\circ$
	by Definition \ref{def:ierase}.

	By induction we know that
	$\Delta^\circ |- F^\circ : (A -> \kappa)^\circ$,
	which simplifies to $\Delta^\circ |- F^\circ : \kappa^\circ$.
	by Definition \ref{def:ierase}.

\item[case] ($->$)
	By induction.

\item[case] ($\forall$)

	We need to show that
	$\Delta^\circ |- (\forall X^\kappa.B)^\circ : *^\circ$,
	which simplifies to
	$\Delta^\circ |- \forall X^{\kappa^\circ}.B^\circ : *$.
	by Definition \ref{def:ierase}.

	Using Theorem \ref{thm:ierasesorting}, we know that
	$|- \kappa^\circ : \square$.

	By induction we know that
	$(\Delta,X^\kappa)^\circ |- B^\circ : *^\circ$,
	which simplifies to
	$\Delta^\circ,X^{\kappa^\circ} |- B^\circ : *$.
	by Definition \ref{def:ierase}.

	Using the kinding rule ($\forall$), we get exactly
	what we need to show:
	$\Delta^\circ |- \forall X^{\kappa^\circ}.B^\circ : *$.

\item[case] ($\forall i$)

	We need to show that
	$\Delta^\circ |- (\forall i^A.B)^\circ : *^\circ$,
	which simplifies to $\Delta^\circ |- B^\circ : *$.
	by Definition \ref{def:ierase}.

	By induction we know that
	$(\Delta,i^A)^\circ |- B^\circ : *^\circ$,
	which simplifies $\Delta^\circ |- B^\circ : *$.
	by Definition \ref{def:ierase}.

\end{itemize}
\end{proof}

\begin{theorem}[index erasure on type constructor equality]
\[ \inference{\Delta |- F=F':\kappa}
		{\Delta^\circ |- F^\circ=F'^\circ:\kappa^\circ}
\]
\end{theorem}
\begin{proof}
By induction on the derivation of type constructor equality.

Most of the cases are done by applying the induction hypothesis
and sometimes using Proposition \ref{prop:wfkind}.

The only interesting cases, which are worth elaborating, are
the equality rules involving substitution.
There are two such rules.

\paragraph{}
  $\inference{\Delta,X^\kappa |- F:\kappa' & \Delta |- G:\kappa}
             {\Delta |- (\lambda X^\kappa.F)\,G = [G/X]F:\kappa'}$ \\

We need to show
$ \Delta^\circ |- ((\lambda X^\kappa.F)\,G)^\circ = ([G/X]F)^\circ : \kappa'^\circ $,
which simplifies to 
$ \Delta^\circ |- (\lambda X^{\kappa^\circ}.F^\circ)\,G^\circ = ([G/X]F)^\circ : \kappa'^\circ $
by Definition \ref{def:ierase}.

By induction, we know that $(\Delta,X^\kappa)^\circ |- F^\circ : \kappa'^\circ$,
which simplifies to $\Delta^\circ,X^{\kappa^\circ} |- F^\circ : \kappa'^\circ$.
by Definition \ref{def:ierase}.

Using the kinding rule ($\lambda$), we get
$\Delta^\circ |- \lambda X^{\kappa^\circ} F^\circ : \kappa^\circ -> \kappa'^\circ$.

Using the kinding rule ($@$), we get
$\Delta^\circ |- (\lambda X^{\kappa^\circ} F^\circ) G^\circ : \kappa^\circ$.

Using the very equality rule of this case,\\ we get 
$\Delta^\circ |- (\lambda X^{\kappa^\circ} F^\circ) G^\circ = [G^\circ/X] F^\circ : \kappa^\circ$.

All we need to check is $([G/X]F)^\circ = [G^\circ/X] F^\circ$,
which is easy to see.

\paragraph{}
  $\inference{\Delta,i^A |- F:\kappa & \Delta;\cdot |- s:A}
             {\Delta |- (\lambda i^A.F)\,\{s\} = [s/i]F:\kappa}$ \\

By induction we know that $\Delta^\circ |- F^\circ : \kappa^\circ$.

The erasure of the left hand side of the equality is\\
$((\lambda i^A.F)\,\{s\})^\circ = (\lambda i^A.F)^\circ = F^\circ$.

All we need to show is $([s/i]F)^\circ = F^\circ$, which is obvious
since index variables can only occur in index terms and index terms
are always erased. Recall the index erasure over type constructors in
Definition \ref{def:ierase}, in particular, $(\lambda i^A.F)^\circ=F^\circ$,
$(F\{s\})^\circ=F^\circ$, and $(\forall i^A.B)^\circ=B^\circ$.
\end{proof}

The proofs for the two theorems above on type constructors need not consider
mutual recursion in the definition of type constructors due to
the erasure operation. Recall that the erasure operation on type constructors
discards the index term ($s$) appearing in the index application $(F\;\{s\})$.
So, there is no need to consider the index terms appearing in the types after
the erasure.

\begin{theorem}[index erasure on well-formed term level contexts]
\label{thm:ierasetmctx}
\[ \inference{\Delta |- \Gamma}{\Delta^\circ |- \Gamma^\circ} \]
\end{theorem}
\begin{proof}
By induction on $\Gamma$.
\begin{itemize}
\item[case] ($\Gamma=\cdot$) It trivially holds.
\item[case] ($\Gamma = \Gamma',x:A$),
we know that  $\Delta |- \Gamma'$ and $\Delta |- A:*$
by the well-formedness rules
and that $\Delta^\circ |- \Gamma'^\circ$ by induction.

From $\Delta |- A:*$, we know that $\Delta^\circ |- A^\circ :*$
by Theorem \ref{thm:ierasekinding}.

We know that $\Delta^\circ |- \Gamma'^\circ,x:A^\circ$
from $\Delta^\circ |- \Gamma'^\circ$ and $\Delta^\circ |- A^\circ :*$
by the well-formedness rules.

Since $\Gamma'^\circ,x:A^\circ = (\Gamma',x:A)^\circ = \Gamma^\circ$
by definition, we know that $\Delta^\circ |- \Gamma^\circ$.
\end{itemize}
\end{proof}

\begin{theorem}[index erasure on well-typed terms]
\label{thm:ierasetyping}
\[ \inference{\Delta |- \Gamma & \Delta;\Gamma |- t : A}
		{\Delta^\circ;\Gamma^\circ |- t : A^\circ}
\]
\end{theorem}
\begin{proof}
	TODO
\end{proof}

%% \begin{theorem}[index erasure on term equality]
%% \[ \inference{\Delta;\Gamma |- t=t':A}
%%  	{\Delta^\circ;\Gamma^\circ |- t=t':A^\circ}
%% \]
%% \end{theorem}


