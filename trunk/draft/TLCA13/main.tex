\documentclass{llncs}
\usepackage{pdfpages}
%% \usepackage[hang,bf]{caption}
\usepackage{color}
\usepackage[fleqn]{amsmath}
\usepackage{amssymb}
\usepackage{semantic}
\usepackage{comment}
\usepackage[numbers]{natbib}

\definecolor{grey}{rgb}{0.8,0.8,0.8}

\newcommand{\Fig}[1]{Figure\,\ref{fig:#1}}
\newcommand{\Figs}[1]{Figures\,\ref{fig:#1}}
\newcommand{\newFi}[1]{\colorbox{grey}{\ensuremath{#1}}}

\newcommand{\ie}{{i.e.}}
\newcommand{\eg}{{e.g.}}
\newcommand{\aka}{{a.k.a.}$\,$}

\newcommand{\Fi}{\ensuremath{\mathsf{F}_i}}
\newcommand{\Fw}{\ensuremath{\mathsf{F}_\omega}}
\newcommand{\fix}{\mathsf{fix}}
\newcommand{\Fix}{\mathsf{Fix}}
\newcommand{\Fixw}{\ensuremath{\Fix_{\omega}}}
\newcommand{\Fixi}{\ensuremath{\Fix_{i}}}

\renewcommand{\l}{\lambda}

\newcommand{\dom}{\mathop{\mathsf{dom}}}
\newcommand{\FV}{\mathop{\mathrm{FV}}}

\newcommand{\Eq}{\mathtt{Eq}}
\newcommand{\LEq}{\mathtt{LEq}}
\newcommand{\Ran}{\mathtt{Ran}}
\newcommand{\Lan}{\mathtt{Lan}}
\newcommand{\s}[1]{\{#1\}}

\title{System \Fi}
\subtitle{a Higher-Order Polymorphic $\lambda$-Calculus\\
	with Erasable Term Indices}
\titlerunning{System \Fi}
\author{Ki Yung Ahn\inst{1} \and Tim Sheard\inst{1} \and
	Marcelo Fiore\inst{2} \and Andrew M. Pitts\inst{2} }
\institute{
	Portland State University, Portland, Oregon, USA
	\thanks{supported by NSF grant 0910500.}
	\\ \email{kya@cs.pdx.edu} \qquad \email{sheard@cs.pdx.edu}
	\and
	University of Cambridge, Cambridge, UK
	\\ \email{\{Marcelo.Fiore,Andrew.Pitts\}@cl.cam.ac.uk}
	}

\begin{document}
\maketitle
\begin{abstract}
TODO
\keywords{TODO, TODO}
\end{abstract}

\section{TODO 1}
TODO
\subsection{TODO 1.1}
TODO
\subsubsection{TODO 1.1.1}
TODO
\paragraph{TODO}

\begin{figure}
\paragraph{Syntax:}
\begin{align*}
\!\!\!\!\!\!\!\!&\text{Sort}
 	& \square
	\\
\!\!\!\!\!\!\!\!&\text{Term Variables}
 	& x,i
\\
\!\!\!\!\!\!\!\!&\text{Type Constructor Variables}
 	& X
\\
\!\!\!\!\!\!\!\!&\text{Kinds}
 	& \kappa		&~ ::= ~ *
				\mid \kappa -> \kappa
				\mid \newFi{A -> \kappa}
\\
\!\!\!\!\!\!\!\!&\text{Type Constructors}
	& A,B,F,G		&~ ::= ~ X
				\mid A -> B
				\mid \lambda X^\kappa.F
				\mid F\,G
				\mid \forall X^\kappa . B \\
				&&& \qquad\qquad\qquad\quad~
				\mid \newFi{\lambda i^A.F
				\mid F\,\{s\}
				\mid \forall i^A . B}
\\
\!\!\!\!\!\!\!\!&\text{Terms}
	& r,s,t			&~ ::= ~ x \mid \lambda x.t \mid r\;s
\\
\!\!\!\!\!\!\!\!&\text{Typing Contexts}
	& \Delta		&~ ::= ~ \cdot
				\mid \Delta, X^\kappa
				\mid \newFi{\Delta, i^A} \\
&	& \Gamma		&~ ::= ~ \cdot
				\mid \Gamma, x : A
\end{align*}
\paragraph{Reduction:} ~~ \fbox{$t \rightsquigarrow t'$} \\
$
 ~~~~
   \inference{}{(\lambda x.t)\,s \rightsquigarrow t[s/x]}
 ~~~~
   \inference{t \rightsquigarrow t'}{\lambda x.t \rightsquigarrow \lambda x.t'}
 ~~~~
   \inference{r \rightsquigarrow r'}{r\;s \rightsquigarrow r'\;s}
 ~~~~
   \inference{s \rightsquigarrow s'}{r\;s \rightsquigarrow r\;s'}
$
\caption{Syntax and Reduction rules of \Fi}
\label{fig:FiSyntax}
\end{figure}




\begin{figure}
\paragraph{Well-formed typing contexts:}
\[ \fbox{$|- \Delta$}
 ~~~~
   \inference{}{|- \cdot}
 ~~~
   \inference{|- \Delta & |- \kappa:\square}
             {|- \Delta,X^\kappa}
      \big( X\notin\dom(\Delta) \big)
 ~~~ \newFi{
   \inference{|- \Delta & \cdot |- A:*}
             {|- \Delta,i^A}
      \big( i\notin\dom(\Delta) \big) }
\]
\[ \fbox{$\Delta |- \Gamma$}
 ~~~~
   \inference{|- \Delta}{\Delta |- \cdot}
 ~~~
   \inference{\Delta |- \Gamma & \Delta |- A:*}
             {\Delta |- \Gamma,x:A}
      \big( x\notin\dom(\Gamma) \big)
 \qquad\qquad\qquad\qquad\qquad\qquad\qquad
\]
~\\
\paragraph{Sorting:} ~~ \fbox{$|- \kappa : \square$}
\[
  \inference[($A$)]{}{|- *:\square}
 ~~~~
   \inference[($R$)]{|- \kappa:\square & |- \kappa':\square}
                    {|- \kappa -> \kappa' : \square}
 ~~~~
   \newFi{
   \inference[($Ri$)]{\cdot |- A:* & |- \kappa:\square}
                     {|- A -> \kappa : \square} }
\]
~\\
\paragraph{Kinding:} ~~ \fbox{$\Delta |- F : \kappa$}
$ \quad
 ~~~~
   \inference[($Var$)]{X^\kappa\in\Delta & |- \Delta}
                       {\Delta |- X : \kappa}
 ~~~~
   \inference[($->$)]{\Delta |- A : * & \Delta |- B : *}
                     {\Delta |- A -> B : * }
$
\[
  \inference[($\lambda$)]{|- \kappa:\square & \Delta,X^\kappa |- F : \kappa'}
                          {\Delta |- \lambda X^\kappa.F : \kappa -> \kappa'}
 ~~~~ \quad ~~
 \newFi{
  \inference[($\lambda i$)]{\cdot |- A:* & \Delta,i^A |- F : \kappa}
                            {\Delta |- \lambda i^A.F : A->\kappa}
		    }
\]
\[ \inference[($@$)]{ \Delta |- F : \kappa -> \kappa'
                    & \Delta |- G : \kappa }
                    {\Delta |- F\,G : \kappa'}
 ~~~~
 \newFi{
   \inference[($@i$)]{ \Delta |- F : A -> \kappa
                     & \Delta;\cdot |- s : A }
                     {\Delta |- F\,\{s\} : \kappa}
	     }
\]
\[ \inference[($\forall$)]{|- \kappa:\square & \Delta, X^\kappa |- B : *}
                          {\Delta |- \forall X^\kappa . B : *}
 ~~~~ \quad ~~~
 \newFi{
   \inference[($\forall i$)]{\cdot |- A:* & \Delta, i^A |- B : *}
                            {\Delta |- \forall i^A . B : *}
		    }
\]
\[ \newFi{
   \inference[($Conv$)]{ \Delta |- A : \kappa
                       & \Delta |- \kappa = \kappa' : \square }
                       {\Delta |- A : \kappa'} }
\]
~\\
\paragraph{Typing:} ~~ \fbox{$\Delta;\Gamma |- t : A$}
$ \quad
 ~~~~
 \inference[($:$)]{(x:A) \in \Gamma & \Delta |- \Gamma} 
                    {\Delta;\Gamma |- x:A}
 ~~~~ \newFi{
   \inference[($:i$)]{i^A \in \Delta & \Delta |- \Gamma} 
                     {\Delta;\Gamma |- i:A} }
$
\[
   \inference[($->$$I$)]{\Delta |- A:* & \Delta;\Gamma,x:A |- t : B}
                        {\Delta;\Gamma |- \lambda x.t : A -> B}
 ~~~~ ~~~~
   \inference[($->$$E$)]{\Delta;\Gamma |- r : A -> B & \Delta;\Gamma |- s : A}
                        {\Delta;\Gamma |- r\;s : B}
\]
\[ \inference[($\forall I$)]{|- \kappa:\square & \Delta, X^\kappa;\Gamma |- t : B}
                            {\Delta;\Gamma |- t : \forall X^\kappa.B}
			    (X\notin\FV(\Gamma))
 ~~~~ ~~~~
   \inference[($\forall E$)]{ \Delta;\Gamma |- t : \forall X^\kappa.B
                            & \Delta |- G:\kappa }
                            {\Delta;\Gamma |- t : B[G/X]}
\]
\[ \!\!\newFi{
   \inference[($\forall I i$)]{\cdot |- A:* & \Delta, i^A;\Gamma |- t : B}
                              {\Delta;\Gamma |- t : \forall i^A.B}
   \left(\begin{matrix}
		i\notin\FV(t),\\
		i\notin\FV(\Gamma)\end{matrix}\right)
 ~~
   \inference[($\forall E i$)]{ \Delta;\Gamma |- t : \forall i^A.B
                              & \Delta;\cdot |- s:A}
                              {\Delta;\Gamma |- t : B[s/i]} }
\]
\[ \inference[($=$)]{\Delta;\Gamma |- t : A & \Delta |- A = B : *}
                    {\Delta;\Gamma |- t : B}
\]
\caption{Well-formedness, Sorting, Kinding, and Typing rules of \Fi}
\label{fig:FiTyping}
\end{figure}












\begin{figure}
\paragraph{Kind equality:} ~~ \fbox{$|- \kappa=\kappa' : \square$}
$
 ~~~~
   \inference{}{|- * = *:\square}
 ~~~~
   \inference{ |- \kappa_1 = \kappa_1' : \square
             & |- \kappa_2 = \kappa_2' : \square }
             {|- \kappa_1 -> \kappa_2 = \kappa_1' -> \kappa_2' : \square}
$
\[ \newFi{
   \inference{\cdot |- A=A':* & |- \kappa=\kappa':\square}
             {|- A -> \kappa = A' -> \kappa' : \square} }
 ~~~~
   \inference{|- \kappa=\kappa':\square}
             {|- \kappa'=\kappa:\square}
 ~~~~
   \inference{ |- \kappa =\kappa' :\square
             & |- \kappa'=\kappa'':\square}
             {|- \kappa=\kappa'':\square}
\]
~\\
\paragraph{Type constructor equality:} ~~ \fbox{$\Delta |- F = F' : \kappa$}
\[ \inference{\Delta,X^\kappa |- F:\kappa' & \Delta |- G:\kappa}
             {\Delta |- (\lambda X^\kappa.F)\,G = F[G/X]:\kappa'}
 ~~~~ \newFi{
   \inference{\Delta,i^A |- F:\kappa & \Delta;\cdot |- s:A}
             {\Delta |- (\lambda i^A.F)\,\{s\} = F[s/i]:\kappa} }
\]
\[ \inference{\Delta |- X:\kappa }{\Delta |- X=X:\kappa}
 ~~~~
   \inference{\Delta |- A=A':* & \Delta |- B=B':*}{\Delta |- A-> B=A'-> B':*}
\]
\[ \inference{|- \kappa:\square & \Delta,X^\kappa |- F=F' : \kappa'}
             {\Delta |- \lambda X^\kappa.F=\lambda X^\kappa.F':\kappa-> \kappa'}
 ~~~~ \quad ~
 \newFi{
   \inference{\cdot |- A:* & \Delta,i^A |- F=F' : \kappa}
             {\Delta |- \lambda i^A.F=\lambda i^A.F' : A -> \kappa}
     }
\]
\[ \inference{\Delta |- F=F':\kappa->\kappa' & \Delta |- G=G':\kappa}
             {\Delta |- F\,G = F'\,G' : \kappa'}
 ~~~~ \newFi{
 \inference{\Delta |- F=F':A->\kappa & \Delta;\cdot |- s=s':A}
             {\Delta |- F\,\{s\} = F'\,\{s'\} : \kappa}
     }
\]
\[
   \inference{|- \kappa:\square & \Delta,X^\kappa |- B=B':*}
             {\Delta |- \forall X^\kappa.B=\forall X^\kappa.B':*}
 ~~~~ \qquad
 \newFi{
   \inference{\cdot |- A:* & \Delta,i^A |- B=B':*}
             {\Delta |- \forall i^A.B=\forall i^A.B':*} }
\]
\[ \inference{\Delta |- F = F' : \kappa}{\Delta |- F' = F : \kappa}
 ~~~~
   \inference{\Delta |- F = F' : \kappa & \Delta |- F' = F'' : \kappa}
             {\Delta |- F = F'' : \kappa}
\]
~\\
\paragraph{Term equality:} ~~ \fbox{$\Delta;\Gamma |- t = t' : A$}
$ \qquad
 ~~~~
   \inference{\Delta;\Gamma,x:A |- t:B & \Delta;\Gamma |- s:A}
             {\Delta;\Gamma |- (\lambda x.t)\,s=t[s/x] : B} $
\[
   \inference{\Delta;\Gamma |- x:A}{\Delta;\Gamma |- x=x:A}
 ~~~~
   \inference{\quad~~ \Delta |- A:* \\ \Delta;\Gamma,x:A |- t=t':B}
             {\Delta;\Gamma |- \lambda x.t = \lambda x.t':B}
 ~~~~
   \inference{\Delta;\Gamma |- r=r':A-> B \\ \Delta;\Gamma |- s=s':A \qquad~}
             {\Delta;\Gamma |- r\;s=r'\;s':B}
\]
\[ \inference{|- \kappa:\square & \Delta, X^\kappa;\Gamma |- t=t' : B}
             {\Delta;\Gamma |- t=t' : \forall X^\kappa.B}
	     (X\notin\FV(\Gamma))
 ~~~~ ~~~~
   \inference{ \Delta;\Gamma |- t=t' : \forall X^\kappa.B
             & \Delta |- G:\kappa }
             {\Delta;\Gamma |- t=t' : B[G/X]}
\]
\[ \newFi{
   \inference{\cdot |- A:* & \Delta, i^A;\Gamma |- t=t' : B}
             {\Delta;\Gamma |- t=t' : \forall i^A.B}
   \left(\begin{smallmatrix}
		i\notin\FV(t),\\
		i\notin\FV(t'),\\
		i\notin\FV(\Gamma)\end{smallmatrix}\right)
 ~~~~
   \inference{ \Delta;\Gamma |- t=t' : \forall i^A.B
             & \Delta;\cdot |- s:A}
             {\Delta;\Gamma |- t=t' : B[s/i]} }
\]
\[ \inference{\Delta;\Gamma |- t=t':A}{\Delta;\Gamma |- t'=t:A}
 ~~~~
   \inference{\Delta;\Gamma |- t=t':A & \Delta;\Gamma |- t'=t'':A}
             {\Delta;\Gamma |- t=t'':A}
\]
\caption{Equality rules of \Fi}
\label{fig:eqFi}
\end{figure}

\section{Metatheory} \label{sec:theory}

The expectation is that System \Fi\ has all the nice properties of System \Fw,
yet is more expressive because of the addition of term-indexed types.

We show some basic well-formedness properties for
the judgments of \Fi\ in \S\ref{ssec:wf}.
We prove erasure properties of \Fi, which captures the idea that indices are
erasable since they are irrelevant for reduction in \S\ref{ssec:erasure}.
We show strong normalization, logical consistence, and subject reduction for
\Fi\ by reasoning about well-known calculi related to \Fi\ in \S\ref{ssec:sn}.

\subsection{Well-formedness Properties and Substitution Lemmas} \label{ssec:wf}




\subsection{Erasure Properties} \label{ssec:erasure}

We define a meta-operation of index erasure that projects $\Fi$-types
to $\Fw$-types.

\begin{definition}[index erasure]\label{def:ierase}
\[ \fbox{$\kappa^\circ$}
 ~~~~ ~~
 *^\circ =
 *
 ~~~~ ~~
 (\kappa_1 -> \kappa_2)^\circ =
 {\kappa_1}^\circ -> {\kappa_2}^\circ
 ~~~~ ~~
 (A -> \kappa)^\circ =
 \kappa^\circ
\]
\[ \fbox{$F^\circ$}
 ~~~~ ~~
 X^\circ =
 X
 ~~~~ ~~~~ ~~~~ ~~~~ ~~~~ ~~~~
 (A -> B)^\circ =
 A^\circ -> B^\circ
\]
\[ \qquad \qquad
 (\lambda X^\kappa.F)^\circ =
 \lambda X^{\kappa^\circ}.F^\circ
 ~~~~ ~~~
 (\lambda i^A.F)^\circ =
 F^\circ
\]
\[ \qquad \qquad
 (F\;G)^\circ =
 F^\circ\;G^\circ
 ~~~~ ~~~~ ~~~~ ~~
 (F\,\{s\})^\circ =
 F^\circ
\]
\[ \qquad \qquad
 (\forall X^\kappa . B)^\circ =
 \forall X^{\kappa^\circ} . B^\circ
 ~~~~ ~~~
 (\forall i^A . B)^\circ =
 B^\circ
\]
\[ \fbox{$\Delta^\circ$}
 ~~~~
 \cdot^\circ = \cdot
 ~~~~ ~~
 (\Delta,X^\kappa)^\circ = \Delta^\circ,X^{\kappa^\circ}
 ~~~~ ~~
 (\Delta,i^A)^\circ = \Delta^\circ
\]
\[ \fbox{$\Gamma^\circ$}
 ~~~~
 \cdot^\circ = \cdot
 ~~~~ ~~~~
 (\Gamma,x:A)^\circ = \Gamma^\circ,x:A^\circ
\]
\end{definition}

\begin{definition}[index variable selection]
	\[ \fbox{$\Delta^\bullet$} ~~~~ ~~ \cdot^\bullet = \cdot \qquad
	(\Delta,X^\kappa)^\bullet = \Delta^\bullet \qquad
	(\Delta,i^A)^\bullet = \Delta^\bullet,i:A
\]
\end{definition}



\begin{theorem}[index erasure on well-sorted kinds]
\label{thm:ierasesorting}
	$\inference{|- \kappa : \square}{|- \kappa^\circ : \square}$
\end{theorem}
\begin{proof}
	By induction on the sort ($\kappa$).
\end{proof}
\begin{remark}
For any well-sorted kind $\kappa$ in \Fi,
$\kappa^\circ$ is a kind in \Fw.
\end{remark}

\begin{theorem}[index erasure on well-formed type level contexts]
\label{thm:ierasetyctx}
$ \inference{|- \Delta}{|- \Delta^\circ} $
\end{theorem}
\begin{proof}
	By induction on the type level context ($\Delta$)
	and using Theorem \ref{thm:ierasesorting}.
\end{proof}
\begin{remark}
For any well-formed type level context $\Delta$ in \Fi,
$\Delta^\circ$ is a well-formed type level context in \Fw.
\end{remark}

\begin{theorem}[index erasure on kind equality]\label{thm:ierasekindeq}
$ \inference{|- \kappa=\kappa':\square}
	{|- \kappa^\circ=\kappa'^\circ:\square}
$
\end{theorem}
\begin{proof}
	By induction on the kind equality judgement.
\end{proof}
\begin{remark}
For any well-sorted kind equality $|- \kappa=\kappa':\square$ in \Fi,
$\kappa^\circ$ and $\kappa'^\circ$ are the syntactically same \Fw\ kinds.
Note that no variables can appear in the erased kinds by definition of
the erasure operation on kinds.
\end{remark}

\begin{theorem}[index erasure on well-kinded type constructors]
\label{thm:ierasekinding}
\[ \inference{|- \Delta & \Delta |- F : \kappa}
		{\Delta^\circ |- F^\circ : \kappa^\circ}
\]
\end{theorem}
\begin{remark} TODO
\end{remark}


\begin{theorem}[index erasure on type constructor equality]
\label{thm:ierasetyconeq}
\[ \inference{\Delta |- F=F':\kappa}
		{\Delta^\circ |- F^\circ=F'^\circ:\kappa^\circ}
\]
\end{theorem}
\begin{remark} TODO
\end{remark}

\begin{theorem}[index erasure on well-formed term level contexts
		prepended by index variable selection]
\label{thm:ierasetmctxivs}
\[ \inference{\Delta |- \Gamma}{\Delta^\circ |- (\Delta^\bullet,\Gamma)^\circ}
\]
\end{theorem}

\begin{theorem}[index erasure on well-typed terms]
\label{thm:ierasetypingall}
\[ \inference{\Delta |- \Gamma & \Delta;\Gamma |- t : A}
		{\Delta^\circ;(\Delta^\bullet,\Gamma)^\circ |- t : A^\circ}
\]
\end{theorem}

\begin{corollary}[index erasure on index-free well-typed terms]
\label{thm:ierasetypingifree}
\[ \inference{ \Delta |- \Gamma & \Delta;\Gamma |- t : A}
		{\Delta^\circ;\Gamma^\circ |- t : A^\circ}
		{\enspace(\dom(\Delta)\cap\FV(t) = \emptyset)}
\]
\end{corollary}

\subsection{Strong Normalization and Logical Consistency} \label{ssec:sn}
Strong normalization is a corollary of the erasure property since we know that
System~\Fw\ is strongly normalizing. Logical consistency is immediate since
System~\Fi\ is a strict subset of the \emph{restricted implicit calculus}
\cite{Miquel00}, which is in turn a restriction of ICC~\cite{Miquel01}.
Subject reduction is also immediate for the same reason.

\section{Related Work} \label{sec:relwork}
TODO

\section{TODO}
TODO

\bibliographystyle{splncsnat}
\bibliography{main}

%% \newpage
%% \appendix

\end{document}
