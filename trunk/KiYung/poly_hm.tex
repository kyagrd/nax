\section{The Hindley-Milner type system} \label{sec:hm}

The Hindly-Milner type system (HM),
\aka\ Damas-Hindley-Milner type system (DHM),
\cite{Hindley69,Milner78,DamMil82,Damas85} infers the most general type scheme
(\aka\ the principal type scheme) for a Curry-style term.
A type scheme is
%%% TODO explain what a type scheme is maybe I should have
%%% already expained this in the previous section of STLC system F
%%% recall the reader on the 

\citet{Hindley69} discovered that there exists a unique principal type scheme
for an object in a combinatory logic. \citet{Milner78} rediscovered this
in the setting of a polymorphic lambda calculus, while he was devising
an algorithm, called the algorithm $W$, which infers a type scheme for
a Curry-style term. \citet{Damas85} developed detailed theories on
Milner's polymorphic lambda calculus (\aka\ let-polymorhpism) and
the type inference algorithm $W$.

$\overline{\Gamma}(A)$ is a closure of type $A$ with respect to $\Gamma$.
$\overline{\Gamma}(A)$ generalizes $A$ by all the free variables of $A$
except the free variables in $\Gamma$. The free variable of $\Gamma$ is
defined as: $\FV(\Gamma) = \bigcup_{x:A\in \Gamma} \FV(A)$.

\begin{figure}
\begin{singlespace}
\small
\begin{align*}
&\textbf{term}&
t,s&~::= ~ x          
    ~  | ~ \l x    . t 
    ~  | ~ t ~ s       
    ~  | ~ \<let> x=s \<in> t
\\
&\textbf{type}&
A,B&~::= ~ A -> B
    ~  | ~ \iota
    ~  | ~ X
\\
&\textbf{type scheme}&
\sigma&~::= ~ \forall X.\sigma
       ~  | ~ A
\\
&\textbf{typing context}&
\Gamma&~::= ~ \cdot 
       ~  | ~ \Gamma, x:\sigma \quad (x\notin \dom(\Gamma))
\end{align*}
\[ \textbf{Type scheme ordering} \quad \framebox{$\sigma \sqsubseteq \sigma'$}\]
\[ \inference{X_1',\dots,X_n'\notin\FV(\forall X_1\dots X_n.A)}
             {\forall X_1\dots X_n.A \;\sqsubseteq\;
	      \forall X_1'\dots X_m'.\,A[B_1/X_1]\cdots[B_n/X_n]} \]
$\!\!\!\!\!\!\!\!\!\!$
\begin{align*}
&\textbf{Delcarative typing rules}&\quad
&\textbf{Syntax-directed typing rules}
	\\
& \inference[\sc Var]{x:\sigma \in \Gamma}{\Gamma |- x:\sigma} &
& \inference[\sc Var$_s$]{x:\sigma \in \Gamma & \sigma \sqsubseteq A}
 	                 {\Gamma |- x:A} \\
& \inference[\sc Abs]{\Gamma,x:A |- t : B}{\Gamma |- \l x   .t : A -> B} &
& \inference[\sc Abs$_s$]{\Gamma,x:A |- t : B}{\Gamma |- \l x   .t : A -> B} \\
& \inference[\sc App]{\Gamma |- t : A -> B & \Gamma |- s : A}
		     {\Gamma |- t~s : B} &
& \inference[\sc App$_s$]{\Gamma |- t : A -> B & \Gamma |- s : A}
		         {\Gamma |- t~s : B} \\
& \inference[\sc Let]{\Gamma |- s : \sigma & \Gamma,x:\sigma |- t : B}
		     {\Gamma |- \<let> x=s \<in> t : B} &
& \inference[\sc Let$_s$]
            {\Gamma |- s : A & \Gamma,x:\overline{\Gamma}(A) |- t : B}
	    {\Gamma |- \<let> x=s \<in> t : B} \\
& \inference[\sc Inst]{\Gamma |- t : \sigma & \sigma \sqsubseteq \sigma'}
		      {\Gamma |- t : \sigma'} &
&\quad\qquad \begin{smallmatrix}\overline{\Gamma}(A)=\forall\vec{X}.A&
			 ~\text{where}~\vec{X}=\FV(A)\setminus\FV(\Gamma)
		 \end{smallmatrix}
		 \\
& \inference[\sc Gen]{\Gamma |- s : \sigma & X \notin\FV(\Gamma)}
		     {\Gamma |- t : \forall X.\sigma}
\end{align*}
\end{singlespace}
\caption{The Hindley-Milner type system}
\label{fig:hm}
\end{figure}

\begin{figure}
\begin{singlespace}
\[ \inference
	{x:\forall X_1\dots X_n.A\in\Gamma \\
	 X_1',\dots,X_n'~\text{fresh}}
        {W(\Gamma,x) = (\emptyset,A[X_1'/X_1]\cdots[X_n'/X_n])}
\]
\[ \inference
	{X~\text{fresh} \\
	 W(\Gamma,x:X,t)=(S_1,A)}
	{W(\Gamma,x)=(S_1,S_1(X -> A))}
\]
\[ \inference
	{W(\Gamma,s)=(S_1,A_1) \\
	 W(S_1 \Gamma,t)=(S_2,A_2) \\
	 X~\text{fresh} \\
	 U(S_2 A_1,A_2 -> X) = S_3 }
	{W(\Gamma,s\;t) = (S_3\circ S_2\circ S_1,S_3 X)}
\]
\[ \inference
	{W(\Gamma,s)=(S_1,A_1) \\
	 W(S_1(\Gamma,x:\overline{S_1\Gamma}(A_1)),t)=(S_2,A_2) }
	{W(\Gamma,\<let> x=s \<in> t) = (S_2\circ S_1,A_2)}
\]
\end{singlespace}
\caption{The type inference algorithm $W$}
\label{fig:algW}
\end{figure}

\subsection{Unification}
TODO

\begin{figure}
\begin{singlespace}
\textbf{Unification}
%% \[ U(A_1,A_2) = \unify(\emptyset,A_1,A_2) \]
\begin{align*}
&U(\iota,&&\iota&) &= S \\
&U(x,&&x&) &= S \\
&U(x_1,&&x_2&) &= \<if> x_1 < x_2 \<then> \{x_1\mapsto x_2\}
				\<else> \{x_2\mapsto x_1\}\\
&U(x_1,&&A_2&) &= \<if> \occurs(x_1,A_2) \<then> \text{fail}
				\<else> \{x_1\mapsto A_2\} \\
&U(A_1,&&x_2&) &= \<if> \occurs(x_2,A_1) \<then> \text{fail}
				\<else> \{x_2\mapsto A_1\} \\
&U(A_1 -> B_1,&&A_2 -> B_2&) &= U(A_1,A_2) \circ U(B_1,B_2) \\
&U(t_1,&&t_2&) &= \text{fail}
\end{align*}
\textbf{Substitution composition}
\begin{align*}
S_1 \circ \emptyset &= S_1 \\
S_1 \circ (\{x\mapsto A_2\}\uplus S_2)
	&= (S_1[S_1 A_2/x]\uplus\{x\mapsto S_1 A_2\}) \circ S_2 \\
%%	\quad (x\notin\dom(S_1)) \\
(\{x\mapsto A_1\}\uplus S_1)\circ
(\{x\mapsto A_2\}\uplus S_2)
	&= (S_1\circ S_2) \circ (\{x\mapsto S A_1\}\uplus S) \\
	&\<where> S=U(A_1,A_2) \\
\end{align*}

\textbf{Well-formed substitution}
\begin{quote}
A substitution $S$ is well-formed when $\dom(S)\cap\FV(\ran(S))=\emptyset$.
\end{quote}

\textbf{A single substitution on substitutions}
\[ S[A/x] = \{x'\mapsto A'[A/x] \mid x'\mapsto A' \in S\} \]

\textbf{Occurs check on a single substitution on types}
\begin{quote}
In the context of unification, we assume that the single substitution on
a type $A[B/x]$ succeeds only when $x$ does not occur in $B$. Otherwise,
when $x$ occurs in $B$, the single substitution $A[B/x]$ fails.
\end{quote}

\end{singlespace}
\caption{The unification algorithm and the composition of substitution}
\label{fig:algU}
\end{figure}

\cite{Robinson65} TODO

\begin{proposition}[unification of identical types] $U(A,A)=\emptyset$
\label{prop:unifyidentical}
\end{proposition}
\begin{proof} Easy by induction on the structure of type $A$.

We need not worry whether $\circ$ may fail or loop,
in the inductive case (\ie, $A(A \to B,A \to B)$),
since it is clear that $\emptyset \circ \emptyset = \emptyset$
from the first equation of the defintion of $\circ$ in Figure \ref{fig:algU}.
\end{proof}
Note, that unification of identical types always suceeds.

\begin{lemma}[substitution composition is idempotent] \label{lem:compident}
	~\\ \indent
	$S\circ S = S$ \quad (when $\circ$ succeeds)
\end{lemma}
\begin{proof}
We prove by induction on the size of the substitution $S$.
The size of $S$ is defined as the size of its domain (\ie, $|S| = |\dom(S)|$).

When $S$ is empty, then it is trivial since
$\emptyset \circ \emptyset = \emptyset$
by the first equation of the substitution composition in Figure \ref{fig:algU}.

When $S$ is non-empty, we should apply the third equation
since the domains of the left- and right-hand side of the composition
obviously share the same variables. Recall the third equation of
the substitution composition in Figure \ref{fig:algU}:
\begin{align*}
(\{x\mapsto A_1\}\uplus S_1)\circ
(\{x\mapsto A_2\}\uplus S_2)
	&= (S_1\circ S_2) \circ (\{x\mapsto S A_1\}\uplus S) \\
	&\<where> S=U(A_1,A_2)
\end{align*}
Note that $\{x\mapsto A_1\}\uplus S_1 = \{x\mapsto A_2\}\uplus S_2$ in our case.
So, is easy to see that $A_1=A_2$ and $S_1=S_2$ Let us give a new name $S'$
for the substitutions $S_1$ and $S_2$ (\ie, $S'=S_1=S_2$) and a new name $A$
for the two types $A_1$ and $A_2$ (\ie, $A=A_1=A_2$).
By Proposition \ref{prop:unifyidentical}, we know that $S=\emptyset$
and $A=A_1=A_2$ in the above equation.  And, by induction,
we know that $S'\circ S' = S'$ (when composition succeeds).
Using what we know, we can simplify the above equation as follows:
\begin{align*}
(\{x\mapsto A\}\uplus S')\circ
(\{x\mapsto A\}\uplus S') &= S'\circ S' \circ \{x\mapsto A\} \\
			  &= S' \circ \{x\mapsto A\} \\
			  &= S' \uplus \{x\mapsto A\} \\
			  &= \{x\mapsto A\} \uplus S'
\end{align*}
The last two steps of the above simplification rely on the fact that
$x\notin\dom(S')$ (thus, using the second equation of $\circ$)
and $\uplus$ is commutative.

Therefore, $S\circ S = S$ (when composition succeeds).
\end{proof}

\begin{proposition}[composition of identical well-formed substitutions succeds]
	\label{prop:compident}
\begin{quote} $S \circ S$ suceeds when $S$ is well-formed \end{quote}
\end{proposition}
\begin{proof}
As discussed in the proof of the previous lemma,
the computation of $S \circ S$ will only involve
the first and thrid equations of the defintion of $\circ$.
The only source of possible failure is in the third equation calling on $U$.
However, we know that $U$ always suceeds when unifying identical types
(Proposition \ref{prop:unifyidentical}).
\end{proof}

From now on, $S_1 \circ S_2 = S$ means that the composition succeeds and
returns $S$. Similarly, $U(A_1,A_2)=S$ means that the unification succeeds
and returns $S$.

\begin{theorem}[substitution composition is idempotent] ~
	\begin{quote} $S\circ S = S$ for any well-formed $S$ \end{quote}
\end{theorem}
\begin{proof}
	By Lemma \ref{lem:compident} and Proposition \ref{prop:compident}.
\end{proof}

\begin{theorem}[unification is commutative] $ U(A_1,A_2) = U(A_2,A_1) $
	\label{thm:commU}
\end{theorem}
\begin{proof} Easy by induction on the structure of $A_1$ and $A_2$.

The base cases (\ie, $U(\iota,\iota)$, $U(x,x)$, $U(x_1,x_2)$,
			$U(x_1,A_2)$, $U(A_1,x_2)$) are trivial.

In the inductive case $U(A_1 -> B_1, A_2 -> B_2)$, we know that
$U(A_1,A_2) = U(A_2,A_1)$ and $U(B_1,A_2) = U(B_2,B_1)$ by induction.
Therefore,
\begin{align*}
U(A_1 -> B_1, A_2 -> B_2)
	&= U(A_1,A_2) \circ U(B_1,B_2) \\
	&= U(A_2,A_1) \circ U(B_2,B_1) = U(A_2 -> B_2, A_1 -> B_1)
\end{align*}
\end{proof}
TODO have we proved that both sides fail at the same time in the inductive case?



A substitution is well-formed when no variables of its domain
occurs in its range (\ie, $\dom(S)\cap\FV(\ran(S))=\emptyset$).

\begin{proposition}[substitution composition preserves well-formedness] ~
\begin{quote}
	Let $S_1$ and $S_2$ be well-formed substitutions.\\
	If $S_1\circ S_2=S$ then $S$ is also well-formed.
\end{quote}
\end{proposition}
\begin{proof}
	TODO
\end{proof}

\begin{proposition}[$U$ produces well-formed substitutions] ~
\begin{quote}
	If $U(A_1,A_2)=S$ then $S$ is well-formed.
\end{quote}
\end{proposition}
\begin{proof}
	TODO
\end{proof}

\begin{lemma}
Let $S$, $\{x\mapsto A'\}$, and $\{x\mapsto A\}$ be well-formed substitutions.
	\[ (S \circ \{x\mapsto A'\}) \circ \{x\mapsto A\} =
	S \circ (\{x\mapsto A'\} \circ \{x\mapsto A\}) \]
\end{lemma}
\begin{proof}
TODO
\end{proof}

\begin{lemma} \label{lem:assocsinglesubst}
Let $S_1$, $S_2$, and $\{x\mapsto A\}$ be well-formed substitutions.
\[ (S_1\circ S_2) \circ \{x\mapsto A\} = S_1 \circ (S_2 \circ \{x\mapsto A\}) \]
\end{lemma}
\begin{proof}
By induction on the size of $S_2$.

When $S_2=\emptyset$, trivial.

When $S_2$ is non-empty.

If $x\notin \dom(S_2)$, let $S_2=\{x'\mapsto A'\}\uplus S_2'$.
\begin{align*}
 &~ (S_1\circ S_2) \circ \{x\mapsto A\} \\
=&~ (S_1\circ(\{x'\mapsto A'\}\uplus S_2')) \circ \{x\mapsto A\} \\
=&~ (S_1\circ(S_2'\uplus\{x'\mapsto A'\})) \circ \{x\mapsto A\} \\
=&~ (S_1\circ(S_2'\circ\{x'\mapsto A'\})) \circ \{x\mapsto A\} \\
=&~ ((S_1\circ S_2')\circ\{x'\mapsto A'\}) \circ \{x\mapsto A\}
	& \text{by induction} \\
=&~ (S_1\circ S_2')\circ(\{x'\mapsto A'\} \circ \{x\mapsto A\})
	& \text{by Lemma TODO} \\
=&~ TODO \\
=&~ S_1 \circ (S_2'\circ (\{x'\mapsto A'\} \circ \{x\mapsto A\})) \\
=&~ S_1 \circ ((S_2'\circ \{x'\mapsto A'\}) \circ \{x\mapsto A\}) \\
=&~ S_1 \circ ((S_2'\uplus \{x'\mapsto A'\}) \circ \{x\mapsto A\}) \\
=&~ S_1 \circ ((\{x'\mapsto A'\}\uplus S_2') \circ \{x\mapsto A\}) \\
=&~ S_1 \circ (S_2 \circ \{x\mapsto A\})
\end{align*}


If $x\in \dom(S_2)$, let $S_2=\{x\mapsto A'\}\uplus S_2'$.
\begin{align*}
 &~ (S_1\circ S_2) \circ \{x\mapsto A\} \\
=&~ (S_1\circ(\{x\mapsto A'\}\uplus S_2')) \circ \{x\mapsto A\} \\
=&~ (S_1\circ(S_2'\uplus\{x\mapsto A'\})) \circ \{x\mapsto A\} \\
=&~ (S_1\circ(S_2'\circ\{x\mapsto A'\})) \circ \{x\mapsto A\} \\
=&~ ((S_1\circ S_2')\circ\{x\mapsto A'\}) \circ \{x\mapsto A\}
	& \text{by induction} \\
=&~ (S_1\circ S_2')\circ(\{x\mapsto A'\} \circ \{x\mapsto A\})
	& \text{by Lemma \ref{TODO}} \\
=&~ (S_1\circ S_2')\circ \{x\mapsto A''\} \\
=&~ S_1 \circ (S_2'\circ \{x\mapsto A''\} )
	& \text{by induction} \\
=&~ S_1 \circ (S_2'\circ (\{x\mapsto A'\} \circ \{x\mapsto A\})) \\
=&~ S_1 \circ ((S_2'\circ \{x\mapsto A'\}) \circ \{x\mapsto A\})
	& \text{by Lemma \ref{TODO}} \\
=&~ S_1 \circ ((S_2'\uplus \{x\mapsto A'\}) \circ \{x\mapsto A\}) \\
=&~ S_1 \circ ((\{x\mapsto A'\}\uplus S_2') \circ \{x\mapsto A\}) \\
=&~ S_1 \circ (S_2 \circ \{x\mapsto A\})
\end{align*}


\end{proof}

\begin{theorem}[substitution composition is associative]
	\[(S_1\circ S_2) \circ S_3 = S_1 \circ (S_2 \circ S_3)
	\qquad\text{($S_1, S_2, S_3$ are well-formed)}
	\]
\end{theorem}
\begin{proof}
By induction on the size of $S_3$.

When $S_3=\emptyset$, trivial.

When $S_3$ is non-empty, let $S_3=\{x\mapsto A\}\uplus S_3'$.
\begin{align*}
(S_1\circ S_2) \circ S_3
	&= (S_1\circ S_2) \circ (\{x\mapsto A\}\uplus S_3') \\
	&= (S_1\circ S_2) \circ (\{x\mapsto A\} \circ S_3') \\
	&= ((S_1\circ S_2) \circ \{x\mapsto A\}) \circ S_3'
	& \text{by induction} \\
	&= (S_1\circ(S_2 \circ \{x\mapsto A\})) \circ S_3'
	& \text{by Lemma \ref{lem:assocsinglesubst}} \\
	&= S_1\circ((S_2 \circ \{x\mapsto A\}) \circ S_3')
	& \text{by induction} \\
	&= S_1\circ(S_2 \circ(\{x\mapsto A\} \circ S_3'))
	& \text{by induction} \\
	&= S_1 \circ (S_2 \circ S_3)
\end{align*}
\end{proof}


\begin{lemma}\label{lem:commsinglesinglesubst}
$ \{x\mapsto A\}\circ\{x'\mapsto A'\} = \{x'\mapsto A'\}\circ\{x\mapsto A\} $
\end{lemma}
\begin{proof}
When either $\{x\mapsto A\}$ or $\{x'\mapsto A'\}$ is not well-formed,
\ie, either $x$ occurs in $A$ or $x'$ occurs in $A'$,
both sides of the equation above fail. The failure will rise from
the occurs check on a single substitution on types (Figure \ref{fig:algU}).
It is easy to check this proceeding by the second equation of $\circ$
for each side. We leave this as an exercise to the reader.

When $x$ occurs in $A'$ and $x'$ occurs $A$ at the same time,
both sides of the equation above fail as well. The failure will rise from
the occurs check on a single substitution on types (Figure \ref{fig:algU}).
It is easy to check this proceeding by the second equation of $\circ$.
We leave this as an exercise to the reader.

When neither $x$ nor $x'$ occur in $A$ and $A'$, it is easy to see
that this lemma holds, by using the second equation of $\circ$.
\begin{align*}
\{x\mapsto A\}\circ\{x'\mapsto A'\}
&= \{x\mapsto A[\{x\mapsto A\} A'/x']\}\uplus\{x'\mapsto\{x\mapsto A\} A'\} \\
&= \{x\mapsto A\}\uplus\{x'\mapsto A'\} \\
&= \{x\mapsto A'\}\uplus\{x\mapsto A\} \\
&= \{x'\mapsto A'[\{x'\mapsto A'\}A/x]\}\uplus\{x\mapsto\{x'\mapsto A'\}A\} \\
&= \{x'\mapsto A'\}\circ\{x\mapsto A\}
\end{align*}

The other two cases to consider are:
\begin{itemize}
\item[(1)] $x$ occurs in $A'$ but $x'$ does not occur in $A$
\begin{align*}
\{x\mapsto A\}\circ\{x'\mapsto A'\}
&= \{x\mapsto A[\{x\mapsto A\} A'/x']\}\uplus\{x'\mapsto\{x\mapsto A\} A'\} \\
&= \{x\mapsto A\}\uplus\{x'\mapsto A'[A/x]\} \\
&= \{x'\mapsto A'[A/x]\}\uplus\{x\mapsto A\} \\
&= \{x'\mapsto A'[\{x'\mapsto A'\}A/x]\}\uplus\{x\mapsto\{x'\mapsto A'\}A\} \\
&= \{x'\mapsto A'\}\circ\{x\mapsto A\}
\end{align*}
\item[(2)] $x'$ occurs in $A$ but $x$ does not occur in $A'$
\begin{align*}
\{x\mapsto A\}\circ\{x'\mapsto A'\}
&= \{x\mapsto A[\{x\mapsto A\} A'/x']\}\uplus\{x'\mapsto\{x\mapsto A\} A'\} \\
&= \{x\mapsto A[A'/x']\}\uplus\{x'\mapsto A'\} \\
&= \{x'\mapsto A'\}\uplus\{x\mapsto A[A'/x']\} \\
&= \{x'\mapsto A'[\{x'\mapsto A'\}A/x]\}\uplus\{x\mapsto\{x'\mapsto A'\}A\} \\
&= \{x'\mapsto A'\}\circ\{x\mapsto A\}
\end{align*}
\end{itemize}
\end{proof}

\begin{lemma}\label{lem:commsingletonsubst}
	$S \circ \{x\mapsto A\} = \{x\mapsto A\} \circ S
	\quad (x \notin \dom(S))$
\end{lemma}
\begin{proof} By induction on the size of $S$.

When $S=\emptyset$ it holds trivially.

When $S$ is non-empty, that is, let $S=\{x'\mapsto A'\}\uplus S'$,
\begin{align*}
S\circ\{x\mapsto A\}
&= (\{x'\mapsto A'\}\uplus S') \circ \{x\mapsto A\} \\
&= (\{x'\mapsto A'\}\circ S') \circ \{x\mapsto A\} \\
&= \{x'\mapsto A'\} \circ (S' \circ \{x\mapsto A\})
& \text{by associativity of $\circ$} \\
&= \{x'\mapsto A'\} \circ (\{x\mapsto A\} \circ S')
& \text{by induction} \\
&= (\{x'\mapsto A'\} \circ \{x\mapsto A\}) \circ S'
& \text{by associativity of $\circ$} \\
&= (\{x\mapsto A\} \circ \{x'\mapsto A\}') \circ S'
& \text{by Lemma \ref{lem:commsinglesinglesubst}} \\
&= \{x\mapsto A\} \circ (\{x'\mapsto A\}' \circ S')
& \text{by associativity of $\circ$} \\
&= \{x\mapsto A\} \circ S
\end{align*}
\end{proof}

\begin{theorem}[substitution composition is commutative]
\[ S_1\circ S_2 = S_2\circ S_1 \qquad\text{($S_1$ and $S_2$ are well-formed)} \]
\end{theorem}
\begin{proof}
By induction on the size of $S_2$.

When $S_2=\emptyset$ it holds trivially.

When $S_2$ is non-empty, let $S_2=\{x\mapsto A_2\}\uplus S_2'$,
\begin{align*}
S_1 \circ S_2
	&= S_1 \circ (\{x\mapsto A_2\}\uplus S_2') \\
	&= S_1 \circ (\{x\mapsto A_2\}\circ S_2') \\
	&= (S_1 \circ \{x\mapsto A_2\}) \circ S_2'
	& \text{by associativity of $\circ$} \\
	&= (\{x\mapsto A_2\}\circ S_1) \circ S_2'
	& \text{by Lemma \ref{lem:commsingletonsubst}} \\
	&= \{x\mapsto A_2\}\circ (S_1 \circ S_2')
	& \text{by associativity of $\circ$} \\
	&= \{x\mapsto A_2\}\circ (S_2' \circ S_1)
	& \text{by induction} \\
	&= (\{x\mapsto A_2\}\circ S_2') \circ S_1
	& \text{by associativity of $\circ$} \\
	&= (\{x\mapsto A_2\}\uplus S_2') \circ S_1 \\
	&= S_2 \circ S_1
\end{align*}
\end{proof}

\begin{lemma} $(S \circ S') A = (S \circ S')(S' A)$
	\label{lem:dupsubstR}
\end{lemma}
\begin{proof}
	TODO
\end{proof}

\begin{lemma} $(S \circ S') A = (S \circ S')(S A)$
	\label{lem:dupsubstL}
\end{lemma}
\begin{proof}
	TODO
\end{proof}


\begin{theorem}[$U$ is sound] \label{prop:soundU}
$ \inference{U(A_1,A_2)=S}{S A_1 = S A_2} $
\end{theorem}
\begin{proof}
By induction on the structure of $A_1$ and $A_2$.
%% By induction on the computation of $U$.
%% Since we assume $U(A_1,A_2)=S$, that is, $U$ succeeds and returns $S$,
%% we know that the computation of $U(A_1,A_2)$ is finite.
%% Therefore, we can induct on the computation of $U$.

The base cases (\ie, $U(\iota,\iota)$, $U(x,x)$, $U(x_1,x_2)$,
			$U(x_1,A_2)$, $U(A_1,x_2)$) are trivial.

In the inductive case $U(A_1 -> B_1, A_2 -> B_2)$, we know that
\[ \inference{U(A_1,A_2)=S' }{S'  A_1 = S'  A_2} ~\text{and}~
   \inference{U(B_1,B_2)=S''}{S'' B_1 = S'' B_2} ~\text{by induction.}
\]
Then, $U(A_1 -> B_1, A_2 -> B_2)=S'\circ S''$ by definition.
\begin{align*}
 &~(S'\circ S'')(A_1 -> B_1) \\
=&~ (S'\circ S'') A_1 -> (S'\circ S'') B_1 \\
=&~ (S'\circ S'')(S' A_1) -> (S'\circ S'')(S'' B_1)
 & \text{by Lemma \ref{lem:dupsubstR} and Lemma \ref{lem:dupsubstL}} \\
=&~ (S'\circ S'')(S' A_2) -> (S'\circ S'')(S'' B_2)
 & \text{by what we know from induction} \\
=&~ (S'\circ S'') A_2 -> (S'\circ S'') B_2
 & \text{by Lemma \ref{lem:dupsubstR} and Lemma \ref{lem:dupsubstL}} \\
=&~ (S'\circ S'')(A_2 -> B_2)
\end{align*}
Therefore, $U(A_1 -> B_1, A_2 -> B_2)=S'\circ S''$ is a unifier.
\end{proof}

\begin{theorem}[$U$ is complete] \label{prop:completeU}
$ \inference{S A_1 = S A_2}{\exists S'.\, U(A_1,A_2)\circ S' = S} $
\end{theorem}
\begin{proof}
	TODO
\end{proof}


